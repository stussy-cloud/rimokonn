<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="theme-color" content="#0f1224"/>
<title>ヒントの町 – ポップシティ v0.6.3</title>
<style>
  :root{ --bg1:#0f1224; --bg2:#15193a; --ink:#e6e7ff; --pane:rgba(255,255,255,.08); --pane2:rgba(255,255,255,.12); }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,Helvetica,Arial}
  .wrap{display:grid;place-items:center;height:100%;gap:16px}

  .hud{position:absolute;left:12px;top:12px;font-size:14px;line-height:1.4;pointer-events:none;text-shadow:0 1px 0 rgba(0,0,0,.35); z-index:4;}
  .hud h1{margin:0 0 8px;font-size:20px}
  .pill{display:inline-block;background:var(--pane);border:1px solid var(--pane2);padding:6px 10px;border-radius:999px;margin-right:8px;color:#fff;}
  .hud #helpBtn{ pointer-events:auto; cursor:pointer; }

  canvas{border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.4), inset 0 0 0 1px rgba(255,255,255,.08);touch-action:none; z-index:1;}

  details.legend{
    position:fixed; right:12px; top:12px; background:var(--pane); border:1px solid var(--pane2); border-radius:12px;
    padding:6px 10px; font-size:12px; max-width:min(360px,86vw); z-index:5; pointer-events:auto; backdrop-filter:blur(8px);
  }
  details.legend[open]{background:rgba(255,255,255,.10)}
  details.legend summary{ display:none; } details.legend summary::-webkit-details-marker{ display:none; }
  .legend-body{ max-height:60vh; overflow:auto; }
  .legend-body h3{ margin:6px 0 4px; font-size:12px; opacity:.9 }
  .legend-body ul{ margin:4px 0 8px 16px; padding:0 } .legend-body li{ margin:2px 0 }

  .panel{position:absolute;left:50%;bottom:12px;transform:translateX(-50%);display:grid;gap:10px;justify-items:center}
  .held{display:grid;grid-auto-flow:column;gap:10px;align-items:center;background:var(--pane);border:1px solid var(--pane2);backdrop-filter:blur(8px);padding:8px 12px;border-radius:14px}
  .btn{pointer-events:all;cursor:pointer;display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.18);
    background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));padding:6px 10px;border-radius:12px;color:#fff;text-decoration:none;font-weight:700;font-size:12px}
  .zoomBtns{position:absolute;right:12px;bottom:12px;display:grid;gap:8px}

  @media (max-width: 480px){
    .hud{ font-size:12px; }
    details.legend{ right:8px; top:8px; font-size:11px; max-width:80vw; }
    .legend-body{ max-height:56vh; }
    .panel{ gap:8px } .btn{ padding:6px 10px; font-size:11px }
  }
</style>
</head>
<body>
<div class="wrap">
  <canvas id="game" width="960" height="600" aria-label="game"></canvas>

  <div class="hud">
    <h1>
      ヒントの町 v0.6.3
      <button class="pill" id="helpBtn">ℹ️ ヘルプ</button>
    </h1>
    <div id="status" style="font-family: ui-monospace, Menlo, Consolas, monospace;"></div>
  </div>

  <details class="legend" id="legendWrap" open>
    <summary>ヘルプ</summary>
    <div id="legend" class="legend-body">
      <h3>操作方法</h3>
      <ul>
        <li><b>タップ</b>：拾う／与える</li>
        <li><b>ピンチ</b>：ズーム</li>
        <li><b>2本指ドラッグ</b>：パン（移動）</li>
        <li><b>＋／−ボタン</b>：ズーム</li>
        <li><b>キャンバスを触る</b>：このヘルプを自動クローズ</li>
      </ul>
      <h3>ヒント</h3>
      <ul><li>ズームしてからパンすると狙いやすい／重い時は少し引くと軽くなります。</li></ul>
    </div>
  </details>

  <div class="panel">
    <div class="held">選択中：<span id="heldIcon">なし</span>
      <button class="btn" id="dropBtn">捨てる</button>
      <button class="btn" id="resetBtn">リセット</button>
    </div>
  </div>

  <div class="zoomBtns">
    <button class="btn" id="zin">＋</button>
    <button class="btn" id="zout">－</button>
  </div>
</div>

<!-- SW キルスイッチ -->
<script>
(() => {
  const qs = new URLSearchParams(location.search);
  if (qs.get('killsw') === '1' && 'serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(rs => {
      rs.forEach(r => r.unregister());
      location.replace(location.origin + location.pathname + '?nocache=' + Date.now() + '&v=' + (qs.get('v')||'') + '&renderer=' + (qs.get('renderer')||''));
    });
  }
})();
</script>

<!-- 診断ローダ：各段階 try/catch、失敗しても main まで必ず進む -->
<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const v = qs.get('v') || ('dev-' + Date.now());
  const wantRenderer = qs.get('renderer') || 'pop';
  window.__diag = { v, scripts: [], errors: [], sw: 'checking...', renderer:'init', fallback:false, drawMs:0, counts:null };

  const st = document.getElementById('status');
  const size = (c)=> (c && c.width) ? `${c.width}x${c.height}` : 'null';
  const ok   = (x)=> typeof x!=='undefined' ? (typeof x==='function'?'ƒ':'●') : '×';
  function hud(){
    const sNames = __diag.scripts.map(s=>s.name).join(',');
    const err    = __diag.errors.length ? __diag.errors[__diag.errors.length-1] : 'none';
    st.innerHTML =
      `build:<b>${__diag.v}</b> / loaded:[${sNames}] / err:${err} / SW:${__diag.sw}`+
      ` / renderer:${__diag.renderer}${__diag.fallback?'(fallback)':''}`+
      ` / draw:${__diag.drawMs.toFixed(1)}ms`+
      (window.CITY_LAYER?` / CITY_LAYER:${size(window.CITY_LAYER)}`:` / CITY_LAYER:null`);
  }
  addEventListener('error', e=>{ __diag.errors.push(e.message||e.type); hud(); });
  addEventListener('unhandledrejection', e=>{ __diag.errors.push('promise:'+(e.reason&&e.reason.message||e.reason)); hud(); });

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(rs=>{
      const a = rs.find(r=>r.active);
      __diag.sw = a ? (a.active && a.active.scriptURL ? a.active.scriptURL.split('/').pop() : 'active') : 'none';
      hud();
    });
  } else { __diag.sw = 'unsupported'; }

  function add(name, src){
    return new Promise((resolve,reject)=>{
      const s = document.createElement('script');
      s.src = src + '?v=' + encodeURIComponent(v);
      s.onload = ()=>{ __diag.scripts.push({name, url:s.src}); hud(); resolve(); };
      s.onerror = (e)=>{ __diag.errors.push('load:'+name); hud(); reject(e); };
      document.body.appendChild(s);
    });
  }

  (async () => {
    // 1) config（必須）
    try { await add('config','./config.js'); } catch(e){ __diag.errors.push('config-failed'); }

    // 2) city（pop優先→失敗時 safe）
    if (wantRenderer==='safe'){
      __diag.renderer='safe';
      try { await add('city_safe','./city_safe.js'); }
      catch(e){ __diag.errors.push('city_safe-failed'); }
    }else{
      __diag.renderer='pop';
      try { await add('city_pop','./city_pop.js'); }
      catch(e){ __diag.fallback=true; __diag.renderer='safe'; try{ await add('city_safe','./city_safe.js'); }catch(_){ __diag.errors.push('city_both_failed'); } }
    }

    // 3) entities（失敗しても続行）
    try { await add('entities','./entities.js'); }
    catch(e){ __diag.errors.push('entities-failed'); }

    // 4) main（必ず行く）
    try { await add('main','./main.js'); }
    catch(e){ __diag.errors.push('main-failed'); }

    hud(); setInterval(hud, 800);
  })();
})();
</script>
</body>
</html>
