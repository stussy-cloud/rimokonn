<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ヒントの町</title>
<link rel="stylesheet" href="./style.css">
</head>
<body>
<div id="status" style="color:white; font-size:12px; font-family:monospace;"></div>
<canvas id="gameCanvas"></canvas>

<!-- 自動バージョン読み込み + 診断ローダー -->
<script>
(function(){
  const v = new URLSearchParams(location.search).get('v') || ('dev-' + Date.now());
  window.__diag = { v, scripts: [], errors: [], sw: 'checking...' };

  const st = document.getElementById('status');
  function sizeOf(c){ try{ return (c && c.width) ? (c.width+'x'+c.height) : 'null'; }catch(_){ return 'null'; } }
  function ok(x){ return (typeof x !== 'undefined') ? (typeof x==='function'?'ƒ':'●') : '×'; }
  function render(){
    const sNames = __diag.scripts.map(s=>s.name).join(',');
    const err    = __diag.errors.length ? __diag.errors[__diag.errors.length-1] : 'none';
    const citySz = sizeOf(window.CITY_LAYER);
    st.innerHTML =
      `build: <b>${__diag.v}</b> / loaded:[${sNames}] / err:${err}` +
      ` / SW:${__diag.sw}` +
      ` / drawCityFast:${ok(window.drawCityFast)} / CITY_LAYER:${citySz}` +
      (typeof window.CITY_NEEDS_REBUILD!=='undefined' ? ` / NEEDS_REBUILD:${window.CITY_NEEDS_REBUILD}` : '');
  }

  window.addEventListener('error', e=>{ __diag.errors.push(e.message || e.type); render(); });
  window.addEventListener('unhandledrejection', e=>{ __diag.errors.push('promise:'+(e.reason&&e.reason.message||e.reason)); render(); });

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(rs=>{
      const a = rs.find(r=>r.active);
      __diag.sw = a ? (a.active && a.active.scriptURL ? a.active.scriptURL.split('/').pop() : 'active') : 'none';
      render();
    });
  } else {
    __diag.sw = 'unsupported';
  }

  function add(name, src){
    return new Promise((resolve,reject)=>{
      const s = document.createElement('script');
      s.src = src + '?v=' + encodeURIComponent(v);
      s.onload = ()=>{ __diag.scripts.push({name, url:s.src}); render(); resolve(); };
      s.onerror = (e)=>{ __diag.errors.push('load:'+name); render(); reject(e); };
      document.body.appendChild(s);
    });
  }

  add('config','./config.js')
    .then(()=>add('city','./city.js'))
    .then(()=>add('entities','./entities.js'))
    .then(()=>add('main','./main.js'))
    .catch(()=>{})
    .finally(()=>{
      render();
      setInterval(render, 1000);
    });
})();
</script>
</body>
</html>
