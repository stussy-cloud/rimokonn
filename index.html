<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="theme-color" content="#0f1224"/>
<title>ãƒ’ãƒ³ãƒˆã®ç”º â€“ ãƒãƒƒãƒ—ã‚·ãƒ†ã‚£ v0.6</title>
<style>
  :root{
    --bg1:#0f1224; --bg2:#15193a; --ink:#e6e7ff;
    --pane:rgba(255,255,255,.08); --pane2:rgba(255,255,255,.12);
    --line:#171a34; --accent:#76a9ff;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,Helvetica,Arial}
  .wrap{display:grid;place-items:center;height:100%;gap:16px}
  .hud{position:absolute;left:12px;top:12px;font-size:14px;line-height:1.4;pointer-events:none;text-shadow:0 1px 0 rgba(0,0,0,.35)}
  .hud h1{margin:0 0 8px;font-size:20px}
  .pill{display:inline-block;background:var(--pane);border:1px solid var(--pane2);padding:3px 8px;border-radius:999px;margin-right:8px}
  canvas{border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.4), inset 0 0 0 1px rgba(255,255,255,.08);touch-action:none}
  details.legend{position:absolute;right:12px;top:12px;background:var(--pane);border:1px solid var(--pane2);border-radius:12px;padding:6px 10px;font-size:12px;max-width:300px}
  details.legend[open]{background:rgba(255,255,255,.1)}
  details.legend summary{cursor:pointer;list-style:none;user-select:none}
  .legend-body div{display:flex;gap:8px;align-items:center;margin:4px 0}
  .panel{position:absolute;left:50%;bottom:12px;transform:translateX(-50%);display:grid;gap:10px;justify-items:center}
  .held{display:grid;grid-auto-flow:column;gap:10px;align-items:center;background:var(--pane);border:1px solid var(--pane2);
    backdrop-filter:blur(8px);padding:8px 12px;border-radius:14px}
  .btn{pointer-events:all;cursor:pointer;display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.18);
    background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));padding:6px 10px;border-radius:12px;color:#fff;text-decoration:none;font-weight:700;font-size:12px}
  .zoomBtns{position:absolute;right:12px;bottom:12px;display:grid;gap:8px}
</style>
</head>
<body>
<div class="wrap">
  <canvas id="game" width="960" height="600" aria-label="game"></canvas>

  <div class="hud">
    <h1>ãƒ’ãƒ³ãƒˆã®ç”º v0.6 <span class="pill">ã‚¿ãƒƒãƒ—: æ‹¾ã†/ä¸ãˆã‚‹</span><span class="pill">ãƒ”ãƒ³ãƒ: ã‚ºãƒ¼ãƒ </span><span class="pill">2æœ¬æŒ‡ãƒ‰ãƒ©ãƒƒã‚°: ãƒ‘ãƒ³</span></h1>
    <div id="status"></div>
  </div>

  <details class="legend" id="legendWrap" open>
    <summary>â„¹ï¸ ãƒ˜ãƒ«ãƒ—ï¼ˆã‚¿ãƒƒãƒ—ã§é–‹é–‰ï¼‰</summary>
    <div id="legend" class="legend-body"></div>
  </details>

  <div class="panel">
    <div class="held">é¸æŠä¸­ï¼š<span id="heldIcon">ãªã—</span>
      <button class="btn" id="dropBtn">æ¨ã¦ã‚‹</button>
      <button class="btn" id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <div class="zoomBtns">
    <button class="btn" id="zin">ï¼‹</button>
    <button class="btn" id="zout">ï¼</button>
  </div>
</div>

<script>
/*** ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ & ãƒãƒªãƒ•ã‚£ãƒ« ===== ***/
const DEBUG_HUD = true;

// SWç™»éŒ²
if('serviceWorker' in navigator){ addEventListener('load',()=>navigator.serviceWorker.register('./service-worker.js').catch(console.warn)); }

// ãƒ‡ãƒãƒƒã‚°HUD
(function(){
  if(!DEBUG_HUD) return;
  const box=document.createElement('div');
  box.style.cssText='position:fixed;left:8px;bottom:8px;background:rgba(0,0,0,.6);color:#fff;padding:6px 8px;border-radius:8px;font:12px/1.4 system-ui;z-index:99999';
  box.id='debugHud'; box.textContent='boot';
  window.addEventListener('DOMContentLoaded',()=>document.body.appendChild(box));
  const log=msg=>box.textContent=msg;
  window.addEventListener('error',e=>log('Error: '+e.message));
  window.addEventListener('unhandledrejection',e=>log('Promise: '+(e.reason&&e.reason.message||e.reason)));
  setInterval(()=>log('tick '+Math.floor(performance.now()/1000)),800);
})();

// roundRect / ellipse
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    const m=Math.min(w,h); if(r>m/2) r=m/2;
    this.beginPath(); this.moveTo(x+r,y);
    this.arcTo(x+w,y,  x+w,y+h,r);
    this.arcTo(x+w,y+h,x,  y+h,r);
    this.arcTo(x,  y+h,x,  y,  r);
    this.arcTo(x,  y,  x+w,y,  r);
    this.closePath(); return this;
  };
}
if(!CanvasRenderingContext2D.prototype.ellipse){
  CanvasRenderingContext2D.prototype.ellipse=function(x,y,rx,ry,rot,s,e,ccw){
    this.save(); this.translate(x,y); this.rotate(rot||0); this.scale(rx,ry);
    this.beginPath(); this.arc(0,0,1,s||0,e||Math.PI*2,!!ccw); this.restore();
  };
}

const DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));
const rand=(a,b)=>a+Math.random()*(b-a);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const pick=a=>a[(Math.random()*a.length)|0];

/*** ===== ã‚³ãƒ³ãƒ•ã‚£ã‚° ===== ***/
const CONFIG={
  world:{w:3600,h:2400,padding:100},           // ã•ã‚‰ã«åºƒå¤§ã«
  speed:1.18, focusedBoost:1.35, r:16,
  roadGap:240, roadW:36, sidewalk:18
};
const PALETTE={
  ink:'#e6e7ff', line:'#171a34',
  road:'#2a2f52', zebra:'#dfe7ff',
  grass:'#1d4d2c', tree:'#2e7d32', bench:'#a06c3f', pole:'#8aa0c9',
  buildBase:['#6ec1ff','#ffd166','#7bd389','#f49ac2','#95d0fc','#ffc2a8'],
  buildRoof:'#233156', window:'#eff5ff', awning:'#ff6b6b',
  npcClothes:['#ff7aa2','#ffd166','#7bd389','#7bb6ff','#f49ac2','#95d0fc']
};

// ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆãƒ’ãƒ³ãƒˆï¼‰
const ITEMS=[
  {id:'photo_short',label:'é«ªå‹(ã‚·ãƒ§ãƒ¼ãƒˆ)',icon:'ğŸ“¸'},
  {id:'photo_long', label:'é«ªå‹(ãƒ­ãƒ³ã‚°)',  icon:'ğŸ“¸'},
  {id:'map',        label:'åœ°å›³',           icon:'ğŸ—ºï¸'},
  {id:'police',     label:'äº¤ç•ª',           icon:'ğŸ‘®'},
  {id:'phone',      label:'å…¬è¡†é›»è©±',       icon:'ğŸ“'},
  {id:'music',      label:'éŸ³æ¥½',           icon:'â™ª'},
  {id:'light',      label:'ã²ã‚‰ã‚ã',       icon:'ğŸ’¡'},
];

// æ‚©ã¿ / ç›®çš„åœ° / ãƒ«ãƒ¼ãƒ«
const NEEDS=[{id:'hair',icon:'ğŸ’‡',label:'é«ªå‹ã«è¿·ã„ä¸­'},{id:'lost',icon:'â“',label:'é“ã«è¿·ã„ä¸­'}];
const STATIONS=[{id:'salon',icon:'ğŸ’ˆ',label:'ã‚µãƒ­ãƒ³'},{id:'koban',icon:'ğŸ‘®',label:'äº¤ç•ª'},{id:'phone',icon:'ğŸ“',label:'å…¬è¡†é›»è©±'},{id:'home',icon:'ğŸ ',label:'ãŠã†ã¡'}];
const RULES={
  hair:{ photo_short:{ok:true,goTo:'salon',hair:'short',msg:'ã“ã®é«ªå‹ã«ï¼'}, photo_long:{ok:true,goTo:'salon',hair:'long',msg:'ã“ã‚Œã§æ±ºã¾ã‚Šï¼'} },
  lost:{ police:{ok:true,escort:true,goTo:'home',msg:'ä¸€ç·’ã«è¡Œãã¾ã—ã‚‡ã†'}, map:{ok:true,goTo:null,msg:'åœ°å›³ã§ã‚ã‹ã£ãŸï¼'}, phone:{ok:false,stillLost:true,msg:'é›»è©±ã§ã¯è§£æ±ºã›ãšâ€¦'} }
};

/*** ===== çŠ¶æ…‹ ===== ***/
const cvs=document.getElementById('game'), ctx=cvs.getContext('2d');
if(typeof ctx.roundRect!=='function'){ ctx.roundRect = CanvasRenderingContext2D.prototype.roundRect.bind(ctx); }

let buildings=[], parks=[], props=[], stationPoints=[], stations=[], inspirations=[];
let residents=[], npcs=[], animals=[], pulses=[], floaters=[];
let held=null;

const cam={x:0,y:0,z:0.6}; const zMin=0.45, zMax=2.2;

/*** ===== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– & å¤‰æ› ===== ***/
function desired(){ const maxW=960,maxH=600,ratio=maxW/maxH;
  let w=Math.min(window.innerWidth-24,maxW),h=Math.min(window.innerHeight-180,maxH);
  w=Math.max(320,w); h=Math.max(260,h); if(w/h>ratio) w=h*ratio; else h=w/ratio; return {w:Math.round(w),h:Math.round(h)}; }
function viewSizeWorld(){ return { w:cvs.width/(DPR*cam.z), h:cvs.height/(DPR*cam.z) }; }
function resize(){ const s=desired(); cvs.style.width=s.w+'px'; cvs.style.height=s.h+'px'; cvs.width=Math.floor(s.w*DPR); cvs.height=Math.floor(s.h*DPR); }
addEventListener('resize',resize);
function setWorld(){ ctx.setTransform(DPR*cam.z,0,0,DPR*cam.z, -cam.x*DPR*cam.z, -cam.y*DPR*cam.z); }
function setScreen(){ ctx.setTransform(DPR,0,0,DPR,0,0); }
function screenToWorld(px,py){ return {x: cam.x + px/cam.z, y: cam.y + py/cam.z}; }

/*** ===== ã‚·ãƒ†ã‚£ç”Ÿæˆï¼ˆã‚ªãƒªã‚¸ãƒŠãƒ«æå†™ï¼‰ ===== ***/
function drawCrosswalk(x,y,w,h,step=10){
  ctx.fillStyle=PALETTE.zebra;
  for(let i=0;i<w;i+=step*2){ ctx.fillRect(x+i,y,step,h); }
}
function drawTree(x,y){
  ctx.fillStyle='rgba(0,0,0,.25)'; ctx.beginPath(); ctx.ellipse(x,y+12,14,6,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle=PALETTE.tree; ctx.beginPath(); ctx.arc(x,y,16,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#5b8a3a'; ctx.beginPath(); ctx.arc(x-8,y+2,10,0,Math.PI*2); ctx.arc(x+9,y+1,8,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#7b4a2b'; ctx.fillRect(x-3,y,6,16);
}
function drawBench(x,y){
  ctx.fillStyle=PALETTE.bench; ctx.fillRect(x-18,y,36,6); ctx.fillRect(x-18,y-8,36,6);
  ctx.fillStyle='#6d4726'; ctx.fillRect(x-16,y+6,4,10); ctx.fillRect(x+12,y+6,4,10);
}
function drawVending(x,y){
  ctx.fillStyle='#4fa3ff'; ctx.roundRect(x-10,y-18,20,36,4); ctx.fill();
  ctx.fillStyle='#eaf5ff'; ctx.fillRect(x-8,y-16,16,10); ctx.fillRect(x-8,y-4,16,12);
  ctx.fillStyle='#c8ddff'; ctx.fillRect(x-6,y-2,12,2); ctx.fillRect(x-6,y+2,12,2);
}
function genCity(){
  buildings.length=0; parks.length=0; props.length=0; stationPoints.length=0;

  // é“è·¯ã®äº¤å·®ç‚¹ã«æ¨ªæ–­æ­©é“ç”¨ãƒã‚¤ãƒ³ãƒˆ
  const roadGap=CONFIG.roadGap, roadW=CONFIG.roadW, sw=CONFIG.sidewalk;

  // ãƒ–ãƒ­ãƒƒã‚¯ç”Ÿæˆï¼ˆå»ºç‰©ï¼†å…¬åœ’ï¼‰
  for(let x=CONFIG.world.w*0.08; x<CONFIG.world.w*0.92; x+=roadGap){
    for(let y=CONFIG.world.h*0.1; y<CONFIG.world.h*0.9; y+=roadGap){
      const bx=x+roadW, by=y+roadW, bw=roadGap-roadW*2, bh=roadGap-roadW*2;

      if(Math.random()<0.12){ // å…¬åœ’
        parks.push({x:bx+8,y:by+8,w:bw-16,h:bh-16});
        // å°ç‰©
        for(let i=0;i<3;i++) props.push({kind:'tree',x:rand(bx+20,bx+bw-20),y:rand(by+20,by+bh-20)});
        props.push({kind:'bench',x:bx+bw*0.5,y:by+bh*0.7});
        continue;
      }

      // å»ºç‰©ï¼ˆåº—/ä½å®…ï¼‰
      const n=5+Math.floor(Math.random()*4);
      for(let i=0;i<n;i++){
        const w=52+Math.random()*70, h=34+Math.random()*60;
        const cx=bx+sw+Math.random()*(bw-w-sw*2), cy=by+sw+Math.random()*(bh-h-sw*2);
        const types=['cafe','book','home','apt','home','home','salon','koban','phone'];
        const t=pick(types);
        buildings.push({x:cx,y:cy,w,h,type:t,c:pick(PALETTE.buildBase)});
        // é§…ï¼ˆç›®çš„åœ°ï¼‰ã«ç›¸å½“ã™ã‚‹åº—èˆ—ã‚’æ§ãˆã‚‹
        if(t==='salon'||t==='koban'||t==='phone'||t==='home'){
          stationPoints.push({x:cx+w/2,y:cy+h/2,type: t==='koban'?'koban':(t==='phone'?'phone':(t==='salon'?'salon':'home'))});
        }
        // å°ç‰©ã®é…ç½®
        if(Math.random()<0.3) props.push({kind:'vending',x:cx+w/2,y:cy+h/2+Math.min(h/2+18,30)});
        if(Math.random()<0.5) props.push({kind:'tree',x:cx+w+10,y:cy+h/2});
      }
    }
  }
}

/*** ===== ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆã‚¹ãƒ—ãƒ©ã‚¤ãƒˆé¢¨ãƒ™ã‚¯ã‚¿ãƒ¼ï¼‰ ===== ***/
class Pulse{constructor(x,y,c){this.x=x;this.y=y;this.r=0;this.life=1;this.c=c||'#3ee0ff'} update(dt){this.r+=260*dt;this.life-=.8*dt}
  draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.strokeStyle=`${this.c}AA`;ctx.lineWidth=2;ctx.stroke();}}
class Floater{constructor(x,y,txt,col){this.x=x;this.y=y;this.t=0;this.txt=txt;this.col=col||'#fff'} update(dt){this.t+=dt;this.y-=18*dt}
  draw(){const a=Math.max(0,1-this.t/1.2); if(a<=0)return; ctx.save(); ctx.globalAlpha=a; ctx.font='bold 14px system-ui'; ctx.textAlign='center'; ctx.textBaseline='bottom'; ctx.fillStyle=this.col; ctx.fillText(this.txt,this.x,this.y); ctx.restore();}}

class Station{constructor(x,y,type){this.x=x;this.y=y;this.type=type}
  draw(){ctx.save();
    // è¶³å…ƒãƒ—ãƒ¬ãƒ¼ãƒˆ
    ctx.fillStyle='rgba(255,255,255,.10)'; ctx.roundRect(this.x-24,this.y-16,48,32,8); ctx.fill();
    const spec=STATIONS.find(s=>s.id===this.type);
    ctx.font='20px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle='#fff'; ctx.fillText(spec?spec.icon:'?',this.x,this.y);
    ctx.restore();}}

class Inspiration{constructor(x,y,type){this.x=x;this.y=y;this.type=type}
  draw(){const spec=ITEMS.find(i=>i.id===this.type); ctx.save(); ctx.font='22px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle='#fff'; ctx.fillText(spec?spec.icon:'?',this.x,this.y); ctx.restore(); }}

// å…¨èº«ã‚­ãƒ£ãƒ©ï¼ˆæŒ‡ç¤ºå¯¾è±¡ï¼‰
function drawPerson(x,y,cl,face,hair,step,hasBag=false){
  // å½±
  ctx.fillStyle='rgba(0,0,0,.25)'; ctx.beginPath(); ctx.ellipse(x,y+12,14,6,0,0,Math.PI*2); ctx.fill();
  // è¶³
  ctx.strokeStyle='#1d203c'; ctx.lineWidth=3;
  ctx.beginPath(); ctx.moveTo(x-6,y+8); ctx.lineTo(x-6+step*2,y+16); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x+6,y+8); ctx.lineTo(x+6-step*2,y+16); ctx.stroke();
  // ä½“
  ctx.fillStyle=cl; ctx.beginPath(); ctx.roundRect(x-12,y-6,24,26,8); ctx.fill();
  // ãƒãƒƒã‚°
  if(hasBag){ ctx.fillStyle='#333'; ctx.beginPath(); ctx.roundRect(x+6,y-2,8,10,3); ctx.fill(); }
  // è…•
  ctx.strokeStyle='#2d3058'; ctx.lineWidth=3;
  ctx.beginPath(); ctx.moveTo(x-12,y); ctx.lineTo(x-20,y+6); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x+12,y); ctx.lineTo(x+20,y+6); ctx.stroke();
  // é¡”
  ctx.fillStyle='#ffe'; ctx.beginPath(); ctx.arc(x,y-10,10,0,Math.PI*2); ctx.fill();
  // é«ª
  ctx.fillStyle=hair.color;
  if(hair.style==='short'){ ctx.beginPath(); ctx.arc(x,y-14,11,Math.PI*1.1,Math.PI*1.9); ctx.lineTo(x+10,y-8); ctx.closePath(); ctx.fill(); }
  if(hair.style==='long'){ ctx.beginPath(); ctx.arc(x,y-15,12,Math.PI*1.1,Math.PI*1.9); ctx.lineTo(x+10,y+2); ctx.arc(x,y+4,12,0,Math.PI,true); ctx.closePath(); ctx.fill(); }
  if(hair.style==='ponytail'){ ctx.beginPath(); ctx.arc(x,y-14,10,Math.PI*1.1,Math.PI*1.9); ctx.fill(); ctx.beginPath(); ctx.ellipse(x+8,y-7,4,8,0,0,Math.PI*2); ctx.fill(); }
  // è¡¨æƒ…
  ctx.fillStyle='#333';
  if(face==='happy'){ ctx.beginPath(); ctx.arc(x-4,y-11,1.6,0,Math.PI*2); ctx.arc(x+4,y-11,1.6,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#333'; ctx.lineWidth=1.6; ctx.beginPath(); ctx.arc(x,y-6,5,0,Math.PI,false); ctx.stroke(); }
  else if(face==='lost'){ ctx.beginPath(); ctx.arc(x-4,y-11,1.6,0,Math.PI*2); ctx.arc(x+4,y-11,1.6,0,Math.PI*2); ctx.fill(); ctx.fillRect(x-4,y-6,8,2); }
  else { ctx.beginPath(); ctx.arc(x-4,y-11,1.4,0,Math.PI*2); ctx.arc(x+4,y-11,1.4,0,Math.PI*2); ctx.fill(); ctx.fillRect(x-4,y-6,8,2); }
}
class Resident{
  constructor(x,y,ci,need,look){ this.x=x;this.y=y;this.vx=0;this.vy=0;this.ci=ci;this.need=need;
    this.state='idle'; this.goal=null; this.face='meh'; this.hair=null; this.escort=false;
    this.look=look; this.walkPhase=Math.random()*Math.PI*2; }
  setGoal(x,y){this.goal={x,y}; this.state='focused'}
  goStation(type){ const list=stations.filter(s=>s.type===type); if(!list.length)return false;
    let best=list[0],bd=Infinity; for(const s of list){const d=(s.x-this.x)**2+(s.y-this.y)**2; if(d<bd){bd=d;best=s;}}
    this.setGoal(best.x,best.y); return true; }
  apply(item){
    const rule=(RULES[this.need]||{})[item.type]; if(!rule){floaters.push(new Floater(this.x,this.y-18,'ï¼Ÿ','#fff7c2')); return;}
    if(rule.ok){
      if(rule.hair) this.hair={style:rule.hair,color:this.look.hair.color};
      if(rule.escort) this.escort=true;
      this.face='happy'; if(rule.goTo) this.goStation(rule.goTo); else this.state='resolved';
      pulses.push(new Pulse(this.x,this.y,'#1df294')); floaters.push(new Floater(this.x,this.y-18,rule.msg||'OK','#baffd9'));
    }else{
      this.face=(this.need==='lost'&&rule.stillLost)?'lost':'meh';
      if(rule.goTo) this.goStation(rule.goTo);
      pulses.push(new Pulse(this.x,this.y,'#ff6b6b')); floaters.push(new Floater(this.x,this.y-18,rule.msg||'â€¦','#ffd0d0'));
    }
  }
  update(dt){
    const sp=CONFIG.speed*(this.state==='focused'?CONFIG.focusedBoost:1)*(this.escort?1.1:1);
    this.walkPhase+=dt*6;
    if(this.state==='focused'&&this.goal){
      const dx=this.goal.x-this.x, dy=this.goal.y-this.y, d=Math.hypot(dx,dy)||1, ux=dx/d, uy=dy/d;
      this.vx+=(ux*sp-this.vx)*0.2; this.vy+=(uy*sp-this.vy)*0.2; this.x+=this.vx; this.y+=this.vy;
      if(d<18){
        if(this.need==='hair'){ this.state='resolved'; this.face='happy'; }
        else if(this.need==='lost'&&this.escort){ this.state='resolved'; this.face='happy'; this.escort=false; }
        else { this.state='resolved'; }
      }
    }else{
      this.vx+=(Math.random()-.5)*0.06; this.vy+=(Math.random()-.5)*0.06;
      const v=Math.hypot(this.vx,this.vy)||1, max=sp*0.7; if(v>max){this.vx=this.vx/v*max; this.vy=this.vy/v*max;}
      this.x+=this.vx; this.y+=this.vy;
    }
    const pad=CONFIG.world.padding; this.x=clamp(this.x,pad,CONFIG.world.w-pad); this.y=clamp(this.y,pad,CONFIG.world.h-pad);
  }
  draw(){ const base=PALETTE.npcClothes[this.ci%PALETTE.npcClothes.length]; const hair=this.hair||this.look.hair; const step=Math.sin(this.walkPhase);
    drawPerson(this.x,this.y,base,this.face,hair,step,false); }
}

// NPCï¼ˆéæ“ä½œã®é€šè¡Œäººï¼‰
class NPC{
  constructor(x,y,cl,look){ this.x=x; this.y=y; this.vx=rand(-.4,.4); this.vy=rand(-.4,.4); this.cl=cl; this.look=look; this.phase=Math.random()*Math.PI*2; }
  update(dt){ this.phase+=dt*6; if(Math.random()<0.02){ this.vx=rand(-.5,.5); this.vy=rand(-.5,.5); }
    this.x+=this.vx; this.y+=this.vy;
    const pad=CONFIG.world.padding; this.x=clamp(this.x,pad,CONFIG.world.w-pad); this.y=clamp(this.y,pad,CONFIG.world.h-pad); }
  draw(){ const step=Math.sin(this.phase); drawPerson(this.x,this.y,this.cl,'meh',this.look.hair,step,Math.random()<.2); }
}

// å‹•ç‰©ï¼ˆçŒ«/çŠ¬/ãƒãƒˆï¼‰
class Animal{
  constructor(x,y,kind){ this.x=x; this.y=y; this.kind=kind; this.vx=rand(-.3,.3); this.vy=rand(-.3,.3); this.t=0; }
  update(dt){ this.t+=dt; if(Math.random()<0.02){ this.vx=rand(-.3,.3); this.vy=rand(-.3,.3); }
    this.x+=this.vx; this.y+=this.vy; const pad=CONFIG.world.padding; this.x=clamp(this.x,pad,CONFIG.world.w-pad); this.y=clamp(this.y,pad,CONFIG.world.h-pad); }
  draw(){
    // å½±
    ctx.fillStyle='rgba(0,0,0,.22)'; ctx.beginPath(); ctx.ellipse(this.x,this.y+6,10,4,0,0,Math.PI*2); ctx.fill();
    // æœ¬ä½“
    ctx.save(); ctx.fillStyle= this.kind==='cat' ? '#d9d0c7' : (this.kind==='dog' ? '#caa383' : '#cfd7e1');
    if(this.kind==='pigeon'){ ctx.beginPath(); ctx.arc(this.x,this.y,6,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#9aa8b5'; ctx.fillRect(this.x-4,this.y+4,8,5); }
    else { ctx.beginPath(); ctx.ellipse(this.x,this.y,8,6,0,0,Math.PI*2); ctx.fill(); ctx.fillRect(this.x-1,this.y-8,2,6); }
    ctx.restore();
  }
}

/*** ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ/åˆæœŸåŒ– ===== ***/
function drawBuilding(b){
  // æ­©é“
  ctx.fillStyle='#1b1f3c'; ctx.fillRect(b.x-4, b.y-4, b.w+8, b.h+8);
  // å»ºç‰©
  ctx.fillStyle=b.c; ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.lineWidth=3;
  ctx.fillRect(b.x,b.y,b.w,b.h); ctx.strokeRect(b.x,b.y,b.w,b.h);
  // å±‹æ ¹ãƒ©ã‚¤ãƒ³
  ctx.fillStyle='#ffffff14'; ctx.fillRect(b.x, b.y, b.w, 6);
  // çª“
  ctx.fillStyle=PALETTE.window;
  const cols=Math.max(2,Math.floor(b.w/24)), rows=Math.max(1,Math.floor(b.h/28));
  for(let i=0;i<cols;i++){ for(let j=0;j<rows;j++){
    const wx=b.x+8+i*(b.w-16)/(cols-1), wy=b.y+10+j*(b.h-18)/(rows-1);
    ctx.fillRect(wx-5,wy-6,10,12);
  }}
  // åº—èˆ—çœ‹æ¿
  if(b.type==='cafe'||b.type==='book'||b.type==='salon'||b.type==='koban'||b.type==='phone'){
    const label = b.type==='cafe'?'â˜•': b.type==='book'?'ğŸ“š': b.type==='salon'?'ğŸ’ˆ': b.type==='koban'?'ğŸ‘®':'ğŸ“';
    ctx.fillStyle=PALETTE.awning; ctx.roundRect(b.x+6,b.y+b.h-18,40,14,6); ctx.fill();
    ctx.fillStyle='#fff'; ctx.font='12px system-ui'; ctx.textAlign='left'; ctx.textBaseline='middle';
    ctx.fillText(label, b.x+12, b.y+b.h-11);
  }
}

function layoutWorld(){
  genCity();
  // ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
  stations = stationPoints.map(s=>new Station(s.x,s.y,s.type));

  // ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡—ä¸­ã«ãƒãƒ©æ’’ãï¼ˆå»ºç‰©ã®è„‡ãªã©ã«ï¼‰
  inspirations.length=0; residents.length=0; npcs.length=0; animals.length=0; pulses.length=0; floaters.length=0; held=null;
  for(let i=0;i<32;i++){
    const b = pick(buildings);
    const px = clamp(b.x + b.w/2 + rand(-60,60), CONFIG.world.padding, CONFIG.world.w-CONFIG.world.padding);
    const py = clamp(b.y + b.h/2 + rand(-60,60), CONFIG.world.padding, CONFIG.world.h-CONFIG.world.padding);
    const it=pick(ITEMS); inspirations.push(new Inspiration(px,py,it.id));
  }

  // æŒ‡ç¤ºå¯¾è±¡ã®ä½äºº
  const hairStyles=['short','long','ponytail'], hairColors=['#222','#6b3a1e','#1e3b6b','#6b1e4f','#2e6b2e'];
  for(let i=0;i<10;i++){
    const need=NEEDS[i%NEEDS.length].id;
    const look={hair:{style:pick(hairStyles), color:pick(hairColors)}};
    const bx=pick(buildings); residents.push(new Resident(bx.x+bx.w/2, bx.y+bx.h/2, i, need, look));
  }

  // NPCç¾¤è¡†
  for(let i=0;i<28;i++){
    const look={hair:{style:pick(hairStyles), color:pick(hairColors)}};
    const bx=pick(buildings); npcs.push(new NPC(bx.x+bx.w/2, bx.y+bx.h/2, pick(PALETTE.npcClothes), look));
  }

  // å‹•ç‰©
  const kinds=['cat','dog','pigeon'];
