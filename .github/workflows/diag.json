name: diag
on:
  push:
    branches: [ main ]

jobs:
  diag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Build diag.json
        run: |
          SHORT=${GITHUB_SHA::7}
          WHEN=$(date -u +%FT%TZ)
          FILES="index.html config.js city_safe.js city_pop.js entities.js main.js service-worker.js manifest.webmanifest polyfills.js"
          echo "{" > diag.json
          echo "  \"sha\":\"$GITHUB_SHA\"," >> diag.json
          echo "  \"short\":\"$SHORT\"," >> diag.json
          echo "  \"when\":\"$WHEN\"," >> diag.json
          echo "  \"pagesBase\":\"https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY#*/}\"," >> diag.json
          echo "  \"files\":{" >> diag.json
          SEP=""
          for f in $FILES; do
            if [ -f "$f" ]; then
              SIZE=$(wc -c < "$f")
              HASH=$(sha256sum "$f" | cut -d' ' -f1)
              echo "  $SEP  \"${f}\": { \"size\": ${SIZE}, \"sha256\": \"${HASH}\" }" >> diag.json
              SEP=","
            fi
          done
          echo "  }" >> diag.json
          echo "}" >> diag.json
          cat diag.json

      - name: Commit diag.json
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add diag.json
          git commit -m "chore(diag): refresh ${GITHUB_SHA::7}" || echo "no changes"
          git push
